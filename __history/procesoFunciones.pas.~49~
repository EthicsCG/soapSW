unit procesoFunciones;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, soapForm;

type
  TForm2 = class(TForm)
    procesoCudBtn: TButton;
    Memo1: TMemo;
    Button1: TButton;
    procedure procesoCudBtnClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
  private
    { Private declarations }
    function getmodule11 (cadena : string; numDig,limMult  : Integer; x10 : Boolean) : string;
  public
    { Public declarations }
  end;

var
  Form2: TForm2;

implementation

{$R *.dfm}

procedure TForm2.procesoCudBtnClick(Sender: TObject);
var sucursal, modalidad, tipEmision, tipFactura, tipSector, nroFactura,
    pos, I : Integer;
    cudp : string;
    nit : Int64;
    modulo11 : string;
begin
  nit := 2525555016;
  sucursal := 0;
  modalidad := 1;
  //online/offline/masiva
  tipEmision := 1;
  //con/sin derecho credito fiscal
  tipFactura := 1;
  //factura compra venta/recibo/notadébito
  tipSector := 1;
  nroFactura := 4220;
  //punto de venta
  pos := 0;
  cudp := Format('%0.*D',[13,nit])+FormatDateTime('yyyyMMddHHnnssZZ', Now)+
          Format('%0.*D', [4, sucursal])+ modalidad.ToString +
          tipEmision.ToString + tipFactura.ToString + Format('%0.*D', [2, tipSector]) +
          Format('%0.*D', [10, nroFactura])+ Format('%0.*D', [4, pos]);
  Memo1.Text := cudp;
  //modulo11 := getmodule11(cudp, 1, 9, false);
  //ShowMessage('fecha: '+modulo11);
end;

//funcion modulo11
procedure TForm2.Button1Click(Sender: TObject);
var cadena : string; numDig, limMult :Integer; x10 :Boolean;  datos :string;
    mult, suma, I, n, dig : Integer;
begin
  cadena := '00025255550162023051211585289900001110100000042200000';
  numDig := 1;
  limMult := 9;
  x10 := False;
  if not x10 then
    numDig := 1;
  for n := 1 to numDig do
  begin
    suma := 0;
    mult := 2;
    for i := cadena.Length -1 downto 0 do
    begin
      suma := suma + (mult *  StrToInt(cadena.Substring(i, i+1)));
      if ++mult > limMult then
        mult := 2;
    end;
    if x10 then
      dig := ((suma *10 ) mod 11) mod 10
    else
      dig := suma mod 11;
    if dig = 10 then
      cadena := cadena + '1';
    if dig = 11 then
      cadena := cadena + '0';
    if dig < 10 then
      cadena := cadena + dig.ToString;
  end;
  datos := cadena.Substring(cadena.Length - numDig, cadena.Length);
  ShowMessage(datos);
end;

function TForm2.getmodule11 (cadena : string; numDig,limMult  : Integer; x10 : Boolean) : string;
var
    mult, suma, I, n, dig : Integer;
begin
  if not x10 then
    numDig := 1;
  for n := 1 to numDig do
  begin
    suma := 0;
    mult := 2;
    for i := cadena.Length -1 downto 0 do
    begin
      suma := suma + (mult *  StrToInt(cadena.Substring(i, i+1)));
      if ++mult > limMult then
        mult := 2;
    end;
    if x10 then
      dig := ((suma *10 ) mod 11) mod 10
    else
      dig := suma mod 11;
    if dig = 10 then
      cadena := cadena + '1';
    if dig = 11 then
      cadena := cadena + '0';
    if dig < 10 then
      cadena := cadena + dig.ToString;
  end;
  Result := cadena.Substring(cadena.Length - numDig, cadena.Length);
end;

end.
